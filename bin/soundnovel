#!/bin/bash

set -eu

readonly WIDTH=80

x=1
y=0
IFS=$'\n'
for line in $(cat lib/*/*); do
  if [ "$line" = "<BLANK>" ]; then
    x=1
    echo
    echo
    continue
  fi

  esc=""
  flag=false
  while read -r c; do
    if [ "$c" = $'\x1b' ]; then
      flag=true
    fi

    if [ $flag = true ] && [ "$c" = m ]; then
      flag=false
      echo -en "$esc"
      x=$((x - 2))
      esc=""
    fi

    if [ $flag = true ]; then
      esc="$esc$c"
      continue
    fi

    echo -ne "\x1b[${x}G"
    echo -n "$c"
    x=$((x + 2))
    if [ "$WIDTH" -lt "$x" ]; then
      x=1
      echo
    fi
    sleep 0.01
  done <<< "$(echo -e $line | grep -o .)"
  esc=""

  echo
  echo -ne "\x1b[1;5m> \x1b[m"
  read ans
  echo -ne "\x1b[1A\x1b[2K\x1b[1A"
  if [ "$ans" = q ]; then
    exit
  fi
done
exit

readonly CURRENT_DIR="$(cd "$(dirname "${BASH_SOURCE:-$0}")";pwd)"
readonly SCRIPT_NAME=$(basename $0)
readonly LIB_DIR=$(dirname $CURRENT_DIR)/lib
readonly NOVEL_DIR=$LIB_DIR/$SCRIPT_NAME
readonly VERSION=1.0.0

main() {
  local cmd=$1
  shift
  case $cmd in
    help)
      usage
      ;;
    version)
      echo $VERSION
      ;;
    list)
      cmd_list "$@"
      ;;
    start)
      cmd_start "$@"
      ;;
    *)
      echo "[WARN] Illegal comamnd. (cmd = $cmd)" >&2
      return 1
      ;;
  esac
}

usage() {
  cat << EOS
$SCRIPT_NAME is a soundnovel cli.

Usage:

    $SCRIPT_NAME <command> [options]

Commands:

    help        Print help.
    version     Print version.
    list        Print all sound novels.
    start       Start sound novel.
EOS
}

cmd_list() {
  ls -1 "$NOVEL_DIR/"
}

cmd_start() {
  :
}

if [ $# -lt 1 ]; then
  (
    echo "[WARN] Must need command."
    echo ""
    usage
  ) >&2
  exit 1
fi

main ${1+"$@"}
